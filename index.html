<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jofert Racing - Gesti贸n</title>
    <link rel="icon" href="logo.png" type="image/png">
    
    <!-- Librer铆as -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Exo+2:ital,wght@0,400;0,600;0,800;1,800&family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    
    <style>
        :root { --racing-black: #0f1014; --racing-dark: #1a1c23; --racing-red: #dc2626; --racing-gray: #f3f4f6; }
        body { font-family: 'Inter', sans-serif; background-color: var(--racing-gray); padding-bottom: 90px; color: #1f2937; }
        .font-racing { font-family: 'Exo 2', sans-serif; }
        .gradient-header { background: linear-gradient(135deg, #e5e7eb 0%, #9ca3af 100%); border-bottom: 4px solid var(--racing-red); }
        input[type="text"], input[type="text"]::placeholder, .uppercase-force { text-transform: uppercase; }
        .inp { width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 8px; font-size: 14px; font-weight: 600; outline: none; }
        .inp:focus { border-color: var(--racing-red); box-shadow: 0 0 0 3px rgba(220, 38, 38, 0.1); }
        .btn-primary { background: var(--racing-black); color: white; font-weight: 700; padding: 10px; border-radius: 8px; display: flex; justify-content: center; items-center; gap: 6px; cursor: pointer; }
        .stat-card { background: white; border-radius: 12px; padding: 16px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); border: 1px solid #e5e7eb; }
        .loader { border: 3px solid #f3f3f3; border-top: 3px solid var(--racing-red); border-radius: 50%; width: 20px; height: 20px; animation: spin 1s linear infinite; }
        .tab-active { color: var(--racing-red); border-top: 3px solid var(--racing-red); background: white; }
        .tab-inactive { color: #9ca3af; border-top: 3px solid transparent; background: white; }
        details > summary { list-style: none; }
        details[open] .rotate-icon { transform: rotate(180deg); }
        .rotate-icon { transition: transform 0.2s; }
        .history-table { width: 100%; border-collapse: collapse; font-size: 11px; }
        .history-table th { background-color: var(--racing-black); color: white; padding: 8px; text-align: left; text-transform: uppercase; }
        .history-table td { padding: 8px; border-bottom: 1px solid #e5e7eb; color: #374151; font-weight: 600; }
        .history-table tr:nth-child(even) { background-color: #f9fafb; }
        .history-table tr:hover { background-color: #fee2e2; cursor: pointer; }
        .toggle-checkbox:checked { right: 0; border-color: #dc2626; }
        .toggle-checkbox:checked + .toggle-label { background-color: #dc2626; }
        .filter-btn { padding: 8px 12px; font-size: 10px; font-weight: 800; text-transform: uppercase; border-radius: 20px; border: 1px solid #e5e7eb; background: white; color: #6b7280; transition: all 0.2s; white-space: nowrap; }
        .filter-btn.active { background: var(--racing-red); color: white; border-color: var(--racing-red); box-shadow: 0 4px 6px -1px rgba(220, 38, 38, 0.3); }
        .autocomplete-items { position: absolute; border: 1px solid #d4d4d4; border-bottom: none; border-top: none; z-index: 99; top: 100%; left: 0; right: 0; border-radius: 0 0 8px 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); max-height: 200px; overflow-y: auto; background: white; }
        .autocomplete-items div { padding: 10px; cursor: pointer; border-bottom: 1px solid #d4d4d4; font-size: 12px; font-weight: bold; color: #374151; text-transform: uppercase; }
        .autocomplete-items div:hover { background-color: #e9e9e9; }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="gradient-header p-4 sticky top-0 z-30 shadow-2xl rounded-b-2xl">
        <div class="max-w-4xl mx-auto flex justify-between items-center">
            <div class="flex items-center gap-4">
                <div class="bg-white h-20 w-20 rounded-full flex items-center justify-center border-4 border-red-600 shadow-lg overflow-hidden relative -my-2">
                    <img src="./logo.png" onerror="this.src='https://cdn-icons-png.flaticon.com/512/3202/3202926.png'" class="w-full h-full object-contain p-1" alt="Jofert">
                </div>
                <div><h1 class="font-racing text-2xl font-black italic tracking-wider leading-none text-slate-900">JOFERT <span class="text-red-600">RACING</span></h1></div>
            </div>
            <div class="flex items-center gap-3">
                <button onclick="window.exportToExcel()" class="bg-slate-800/10 hover:bg-slate-800/20 p-2 rounded-lg border border-slate-800/10 text-slate-800" title="Excel"><i data-lucide="file-spreadsheet" class="w-6 h-6 text-green-600"></i></button>
                <div id="connectionStatus" class="w-3 h-3 rounded-full bg-red-500 border-2 border-white shadow-md" title="Estado Conexi贸n"></div>
            </div>
        </div>
    </header>

    <main class="max-w-4xl mx-auto px-4 mt-8 pb-24">
        <!-- VISTA 1: TRABAJOS -->
        <div id="view-home" class="space-y-6">
            <section class="bg-white p-5 rounded-2xl shadow-sm border border-slate-200 relative overflow-visible">
                <div class="absolute top-0 left-0 w-1 h-full bg-red-600" id="formBorderColor"></div>
                <div id="editModeHeader" class="hidden mb-4 bg-amber-50 text-amber-800 text-xs font-bold p-2 rounded border border-amber-200 text-center">锔 EDITANDO ORDEN</div>
                <div class="flex justify-between items-center mb-4 flex-wrap gap-2">
                    <div class="flex items-center gap-2"><h2 class="font-racing text-lg font-bold text-slate-800 italic uppercase" id="formTitleText">Nuevo Trabajo</h2></div>
                    <div class="flex gap-4">
                        <label class="flex items-center cursor-pointer"><div class="relative"><input type="checkbox" id="isCounterSale" class="sr-only peer" onchange="window.toggleCounterSale()"><div class="w-9 h-5 bg-gray-300 peer-checked:bg-red-600 rounded-full shadow-inner transition-colors relative"><div class="absolute w-3 h-3 bg-white rounded-full shadow top-1 left-1 transition-transform peer-checked:translate-x-4"></div></div></div><span class="ml-2 text-[10px] font-bold text-slate-500 uppercase">Mostrador</span></label>
                        <label class="flex items-center cursor-pointer"><div class="relative"><input type="checkbox" id="isQuoteToggle" class="sr-only peer" onchange="window.toggleQuoteMode()"><div class="w-9 h-5 bg-gray-300 peer-checked:bg-amber-500 rounded-full shadow-inner transition-colors relative"><div class="absolute w-3 h-3 bg-white rounded-full shadow top-1 left-1 transition-transform peer-checked:translate-x-4"></div></div></div><span class="ml-2 text-[10px] font-bold text-slate-500 uppercase" id="quoteLabel">Presupuesto</span></label>
                    </div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-3 mb-4">
                    <input type="hidden" id="orderId">
                    <div class="md:col-span-2 bg-slate-50 p-2 rounded-lg border border-slate-200 flex items-center gap-2"><span class="text-xs font-bold text-slate-500 uppercase">Fecha:</span><input type="date" id="date" class="bg-transparent font-bold text-slate-800 outline-none flex-1"></div>
                    <input type="text" id="clientName" placeholder="NOMBRE CLIENTE" class="inp" oninput="this.value=this.value.toUpperCase()">
                    <div id="personalDataGroup" class="contents"><input type="tel" id="clientPhone" placeholder="CELULAR" class="inp"><input type="text" id="clientDni" placeholder="DNI / PATENTE" class="inp font-mono" oninput="this.value=this.value.toUpperCase()"></div>
                    <div id="vehicleDataGroup" class="contents"><div class="flex gap-2"><input type="text" id="vehicleModel" placeholder="VEHCULO" class="inp flex-[2]" oninput="this.value=this.value.toUpperCase()"><input type="text" id="vehiclePlate" placeholder="PATENTE" class="inp uppercase font-mono flex-1" oninput="this.value=this.value.toUpperCase()"></div><input type="number" id="vehicleKm" placeholder="KM" class="inp font-mono md:col-span-2" title="Kilometraje"></div>
                </div>
                <div class="bg-slate-50 p-3 rounded-xl border border-slate-200 mb-4 relative">
                    <div class="flex gap-2 mb-2 relative">
                        <div class="flex-[2] relative">
                            <input type="text" id="itemDesc" placeholder="BUSCAR O DESCRIBIR..." class="inp w-full uppercase" oninput="window.searchProducts(this.value)" autocomplete="off">
                            <div id="productDropdown" class="autocomplete-items hidden"></div>
                        </div>
                        <select id="itemType" onchange="window.toggleCostInput()" class="inp w-auto text-xs font-bold text-slate-600">
                            <option value="labor">MANO OBRA</option>
                            <option value="part">REPUESTO</option>
                            <option value="service">SERVICIO</option>
                        </select>
                    </div>
                    <div class="grid grid-cols-3 gap-2">
                        <div class="relative"><label class="text-[9px] font-bold text-gray-400 absolute top-1 left-2">COSTO</label><input type="number" id="itemBuyPrice" placeholder="0" class="inp pt-5 font-bold text-red-600 disabled:bg-gray-100 disabled:text-gray-400" oninput="window.calcPriceFromMargin()"></div>
                        <div class="relative"><label class="text-[9px] font-bold text-gray-400 absolute top-1 left-2">MARGEN %</label><input type="number" id="itemMargin" placeholder="%" class="inp pt-5 font-bold text-blue-600" oninput="window.calcPriceFromMargin()"></div>
                        <div class="relative"><label class="text-[9px] font-bold text-gray-400 absolute top-1 left-2">VENTA</label><input type="number" id="itemSellPrice" placeholder="0" class="inp pt-5 font-black text-slate-800"></div>
                    </div>
                    <button onclick="window.addOrUpdateItem()" id="btnAddItem" class="btn-primary w-full mt-2 shadow-lg"><i data-lucide="plus" class="w-5 h-5"></i> AGREGAR ITEM</button>
                </div>
                <div id="tempListContainer" class="hidden space-y-4">
                    <div class="bg-slate-50 rounded-xl border border-slate-200 overflow-hidden"><table class="w-full text-sm"><tbody id="tempList" class="divide-y divide-slate-200"></tbody></table></div>
                    <div id="orderFooter" class="bg-slate-900 p-4 rounded-xl text-white shadow-xl transition-colors duration-300">
                        <div class="flex justify-between items-center mb-4 border-b border-white/10 pb-2"><p class="text-[10px] font-bold uppercase tracking-widest opacity-70">Total Estimado</p><p class="font-racing text-3xl font-black italic" id="previewTotal">$0</p></div>
                        <div id="paymentSection" class="bg-white/10 p-3 rounded-lg mb-3 border border-white/5">
                            <div class="flex items-center justify-between mb-2"><label class="text-xs font-bold text-slate-200 flex items-center gap-2"><input type="checkbox" id="checkPaidFull" onchange="window.togglePaymentInput()" class="w-4 h-4 rounded text-red-600 focus:ring-0 cursor-pointer"> PAGADO TOTALMENTE</label><select id="initialPaymentMethod" class="text-[10px] text-slate-800 rounded p-1 font-bold"><option value="Efectivo">Efectivo</option><option value="Banco Jose">Banco Jose</option><option value="Banco Fer">Banco Fer</option></select></div>
                            <div id="partialPaymentContainer" class="flex items-center gap-2"><span class="text-xs text-slate-400">O PAGO PARCIAL:</span><input type="number" id="initialPayment" placeholder="$" class="bg-slate-700 text-white border-none rounded px-2 py-1 text-sm w-full font-bold"></div>
                        </div>
                        <div id="editPaymentSection" class="hidden mb-3"><button onclick="window.openCurrentOrderPayment()" class="w-full bg-green-600 hover:bg-green-700 text-white py-3 rounded-lg font-bold text-sm uppercase flex items-center justify-center gap-2 shadow-lg transform transition hover:scale-[1.02]"><i data-lucide="dollar-sign" class="w-5 h-5"></i> GESTIONAR PAGOS / SALDO</button></div>
                        <div class="flex gap-2"><button onclick="window.resetForm()" id="btnCancelMain" class="hidden w-1/3 bg-white/10 hover:bg-white/20 text-white py-3 rounded-lg font-bold text-xs uppercase">CANCELAR EDICIN</button><button onclick="window.saveOrder()" id="btnSaveMain" class="w-full bg-red-600 hover:bg-red-700 text-white py-3 rounded-lg font-bold uppercase text-xs tracking-wider transition flex justify-center items-center gap-2"><i data-lucide="save" class="w-4 h-4"></i> <span id="btnSaveText">CONFIRMAR ORDEN</span></button></div>
                    </div>
                </div>
            </section>

            <section>
                <div class="flex flex-col gap-3 mb-4"><div class="flex justify-between items-center px-1"><h3 class="font-racing font-bold text-slate-700 italic uppercase">Listado</h3><input type="month" id="filterMonth" class="text-xs border rounded-md p-1 font-bold text-slate-600 bg-white shadow-sm"></div><div class="flex gap-2 overflow-x-auto pb-1 no-scrollbar"><button onclick="window.setListFilter('all')" id="filter-all" class="filter-btn active">TODOS</button><button onclick="window.setListFilter('debt')" id="filter-debt" class="filter-btn">A COBRAR</button><button onclick="window.setListFilter('paid')" id="filter-paid" class="filter-btn">FINALIZADOS</button><button onclick="window.setListFilter('quote')" id="filter-quote" class="filter-btn">PRESUPUESTOS</button></div></div>
                <div id="ordersList" class="space-y-3 uppercase-force"><div class="p-8 text-center text-slate-400"><div class="loader mb-2 mx-auto"></div>Cargando...</div></div>
            </section>
        </div>

        <!-- 2. LISTA DE PRECIOS -->
        <div id="view-products" class="hidden space-y-6 pb-20">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div class="bg-white p-5 rounded-2xl shadow-sm border border-slate-200"><h2 class="font-racing text-lg font-bold text-slate-800 italic uppercase mb-4 flex items-center gap-2"><i data-lucide="upload" class="w-5 h-5 text-red-600"></i> Importar Excel</h2><div class="space-y-3"><div><label class="text-[10px] font-bold text-slate-400 uppercase">Proveedor</label><input type="text" id="importProvider" placeholder="EJ: VALVOLINE" class="inp w-full uppercase border-l-4 border-l-red-500"></div><div><label class="text-[10px] font-bold text-slate-400 uppercase">Archivo CSV</label><p class="text-[9px] text-slate-400 mb-1">Col A: C贸digo | Col B: Descripci贸n | Col C: Costo</p><input type="file" id="csvInput" accept=".csv" class="block w-full text-xs text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-xs file:font-bold file:bg-slate-800 file:text-white hover:file:bg-slate-700 mb-2"></div><button onclick="window.importCSV()" class="w-full bg-green-600 hover:bg-green-700 text-white text-xs font-bold py-3 rounded flex items-center justify-center gap-2 shadow-md"><i data-lucide="save" class="w-3 h-3"></i> PROCESAR</button></div></div>
                <div class="bg-white p-5 rounded-2xl shadow-sm border border-slate-200"><h2 class="font-racing text-lg font-bold text-slate-800 italic uppercase mb-4 flex items-center gap-2"><i data-lucide="settings" class="w-5 h-5 text-slate-500"></i> Administrar</h2><div class="flex gap-2"><input type="text" id="deleteProviderName" placeholder="BORRAR PROVEEDOR" class="inp w-full uppercase"><button onclick="window.deleteByProvider()" class="bg-red-600 hover:bg-red-700 text-white px-4 rounded font-bold text-xs flex items-center"><i data-lucide="trash-2" class="w-4 h-4"></i></button></div></div>
            </div>
            <div class="bg-white p-4 rounded-2xl shadow-sm border border-slate-200"><div class="relative mb-4"><input type="text" id="productSearch" placeholder="BUSCAR EN LISTA..." class="inp pl-8 uppercase font-bold text-xs w-full" onkeyup="window.renderProductsList()"><i data-lucide="search" class="w-4 h-4 text-slate-400 absolute left-2 top-3"></i></div><div class="overflow-y-auto max-h-96"><table class="w-full text-xs"><thead class="bg-slate-800 text-white sticky top-0"><tr><th class="p-2 text-left w-24">CDIGO</th><th class="p-2 text-left">DESCRIPCIN</th><th class="p-2 text-left w-24">PROV.</th><th class="p-2 text-right">COSTO</th><th class="p-2"></th></tr></thead><tbody id="productsTableBody" class="uppercase-force divide-y divide-slate-100"></tbody></table></div></div>
        </div>

        <!-- 3. HISTORIAL -->
        <div id="view-search" class="hidden space-y-6 pb-20">
            <div class="bg-white p-5 rounded-2xl shadow-sm border border-slate-200"><h2 class="font-racing text-lg font-bold text-slate-800 italic uppercase mb-4 flex items-center gap-2"><i data-lucide="car" class="w-5 h-5 text-red-600"></i> Historial por Veh铆culo</h2><div class="relative"><input type="text" id="searchInput" placeholder="PATENTE, CLIENTE O DNI..." class="inp pl-10 uppercase font-bold text-slate-700" onkeyup="window.performSearch()"><i data-lucide="search" class="w-5 h-5 text-slate-400 absolute left-3 top-3"></i></div></div>
            <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden overflow-x-auto"><table class="history-table"><thead><tr><th>FECHA</th><th>VEHCULO</th><th>CLIENTE</th><th>KM</th><th>TOTAL</th></tr></thead><tbody id="historyTableBody" class="uppercase-force"></tbody></table></div>
        </div>

        <!-- 4. RETIROS -->
        <div id="view-withdrawals" class="hidden space-y-6 pb-20">
            <div class="bg-white p-5 rounded-2xl shadow-sm border border-slate-200"><h2 class="font-racing text-lg font-bold text-slate-800 italic uppercase mb-4 flex items-center gap-2"><i data-lucide="banknote" class="w-5 h-5 text-red-600"></i> Gesti贸n de Retiros</h2><div class="flex justify-between items-center mb-4"><div class="grid grid-cols-2 gap-3 flex-1"><select id="wdPerson" class="inp font-bold text-slate-700"><option value="Fer">FERNANDO</option><option value="Me">JOSE</option></select><select id="wdMethod" class="inp text-sm"><option value="Efectivo"> EFECTIVO</option><option value="Banco"> TRANSFERENCIA</option></select><input type="date" id="wdDate" class="inp col-span-2"><input type="number" id="wdAmount" placeholder="MONTO $" class="inp col-span-2 text-lg font-black text-slate-800 border-slate-400"><button onclick="window.cancelEditWithdrawal()" id="btnCancelWd" class="btn-primary bg-gray-500 col-span-1 hidden">CANCELAR</button><button onclick="window.addWithdrawal()" id="btnSaveWd" class="btn-primary bg-red-600 col-span-2 py-3">CONFIRMAR</button></div></div></div>
            <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-4">
                <div class="border-b border-slate-100 pb-2 mb-2 flex justify-between items-center">
                    <h3 class="font-bold text-slate-700 text-xs uppercase">Historial</h3>
                    <input type="month" id="wdHistoryFilter" class="text-xs border rounded p-1 font-bold text-slate-600" onchange="window.renderWithdrawals()">
                </div>
                <div id="withdrawalsList" class="divide-y divide-slate-100 text-sm"></div>
            </div>
        </div>

        <!-- 5. GASTOS -->
        <div id="view-expenses" class="hidden space-y-6 pb-20">
            <div class="bg-white p-5 rounded-2xl shadow-sm border border-slate-200"><h2 class="font-racing text-lg font-bold text-slate-800 italic uppercase mb-4 flex items-center gap-2"><i data-lucide="receipt" class="w-5 h-5 text-red-600"></i> Gesti贸n de Gastos Fijos</h2><div class="bg-slate-50 p-4 rounded-lg border border-slate-200 mb-4"><div class="grid grid-cols-2 gap-3 mb-3"><input type="text" id="manageExpenseDesc" placeholder="CONCEPTO (LUZ, ALQUILER)" class="inp w-full uppercase col-span-2"><input type="number" id="manageExpenseAmount" placeholder="MONTO $" class="inp w-full text-lg font-bold"><select id="manageExpenseMethod" class="inp text-sm"><option value="Efectivo"> EFECTIVO</option><option value="Banco"> BANCO</option></select></div><div class="flex gap-2"><button id="btnCancelExpense" onclick="window.cancelEditExpense()" class="w-1/3 bg-gray-500 hover:bg-gray-600 text-white font-bold py-3 rounded-lg shadow-lg uppercase text-xs hidden">CANCELAR</button><button id="btnSaveExpense" onclick="window.addExpenseFromTab()" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-3 rounded-lg shadow-lg uppercase text-xs tracking-wide flex justify-center items-center gap-2"><i data-lucide="plus-circle" class="w-4 h-4"></i> REGISTRAR GASTO</button></div></div><div class="flex justify-end mb-2"><select id="filterManageExpenses" onchange="window.renderExpensesList()" class="text-[10px] border rounded p-1 bg-white font-bold text-slate-500 shadow-sm"><option value="month">VER: ESTE MES</option><option value="all">VER: TODOS (HISTORIAL)</option></select></div><div id="manageExpensesList" class="space-y-2 text-sm"></div></div>
        </div>

        <!-- 6. FINANZAS -->
        <div id="view-finance" class="hidden space-y-6 pb-20">
            <div class="flex justify-between items-center mb-4"><div><h2 class="font-racing text-xl font-black italic text-slate-800 uppercase">Finanzas</h2><p class="text-xs text-slate-500">ANLISIS MENSUAL</p></div><input type="month" id="dashMonth" onchange="window.renderDashboard()" class="text-sm font-bold border border-slate-300 rounded-lg p-2 bg-white text-red-600 shadow-sm"></div>
            <div class="bg-slate-900 rounded-xl p-5 text-white shadow-lg border-l-4 border-white mb-4"><div class="flex justify-between items-start"><div><p class="text-[10px] font-bold uppercase tracking-widest text-slate-400">INGRESOS BRUTOS (TOTAL)</p><p class="font-racing text-2xl font-black text-white" id="grossIncomeDisplay">$0</p></div><div class="text-right"><p class="text-[10px] font-bold uppercase tracking-widest text-red-400">FONDO REPOSICIN (COSTOS)</p><p class="font-racing text-xl font-bold text-red-300" id="repoBalanceHeader">$0</p></div></div></div>
            <div class="bg-white rounded-xl p-5 shadow-lg border-2 border-emerald-500 relative overflow-hidden mb-4"><div class="absolute top-0 right-0 -mt-2 -mr-2 w-20 h-20 bg-emerald-100 rounded-full opacity-50"></div><p class="text-[10px] font-bold uppercase tracking-widest text-emerald-600 mb-1">GANANCIA NETA A DIVIDIR</p><p class="font-racing text-4xl font-black text-emerald-600 leading-none" id="netProfitSplit">$0</p><p class="text-[10px] text-slate-400 mt-2 font-bold">(Mano de Obra + Ganancia Repuestos + Ganancia Servicios)</p></div>
            <div class="grid grid-cols-3 gap-2 mb-4">
                <div class="bg-white rounded-xl p-2 shadow-sm border border-slate-200"><h4 class="text-[10px] font-black text-indigo-600 uppercase mb-1 border-b pb-1">MANO OBRA</h4><div class="space-y-0.5 text-[10px]"><div class="flex justify-between text-slate-500"><span>Ingreso:</span><span id="laborGross" class="font-bold">$0</span></div><div class="flex justify-between text-red-500"><span>Gastos:</span><span id="laborExpenses" class="font-bold">-$0</span></div><div class="border-t pt-1 mt-1 flex justify-between text-slate-800"><span class="font-bold">UTILIDAD:</span><span id="laborNet" class="font-black">$0</span></div></div></div>
                <div class="bg-white rounded-xl p-2 shadow-sm border border-slate-200"><h4 class="text-[10px] font-black text-orange-600 uppercase mb-1 border-b pb-1">REPUESTOS</h4><div class="space-y-0.5 text-[10px]"><div class="flex justify-between text-slate-500"><span>Venta:</span><span id="partsGross" class="font-bold">$0</span></div><div class="flex justify-between text-amber-600"><span>Costo:</span><span id="partsCostDisplay" class="font-bold">-$0</span></div><div class="border-t pt-1 mt-1 flex justify-between text-slate-800"><span class="font-bold">UTILIDAD:</span><span id="partsNet" class="font-black">$0</span></div></div></div>
                <div class="bg-white rounded-xl p-2 shadow-sm border border-slate-200"><h4 class="text-[10px] font-black text-emerald-600 uppercase mb-1 border-b pb-1">SERVICIOS</h4><div class="space-y-0.5 text-[10px]"><div class="flex justify-between text-slate-500"><span>Venta:</span><span id="servicesGross" class="font-bold">$0</span></div><div class="flex justify-between text-amber-600"><span>Costo:</span><span id="servicesCostDisplay" class="font-bold">-$0</span></div><div class="border-t pt-1 mt-1 flex justify-between text-slate-800"><span class="font-bold">UTILIDAD:</span><span id="servicesNet" class="font-black">$0</span></div></div></div>
            </div>
            <div class="mb-4"><h4 class="font-racing text-sm font-bold italic text-slate-700 mb-2 flex items-center gap-2 uppercase"><i data-lucide="wallet" class="w-4 h-4"></i> Disponibilidad Actual (Mes)</h4><div class="grid grid-cols-2 gap-3"><div class="bg-emerald-900 text-white p-3 rounded-xl shadow-md"><p class="text-[9px] font-bold uppercase opacity-70">Efectivo en Caja</p><p class="font-racing text-xl font-black text-emerald-400" id="cashBalance">$0</p></div><div class="bg-blue-900 text-white p-3 rounded-xl shadow-md"><p class="text-[9px] font-bold uppercase opacity-70">Cuenta Bancaria</p><p class="font-racing text-xl font-black text-blue-400" id="bankBalance">$0</p></div></div></div>
            <div class="grid grid-cols-1 gap-4 mb-4">
                <div class="bg-white rounded-xl shadow-sm border border-indigo-200 overflow-hidden"><div class="bg-indigo-600 p-3 flex justify-between items-center text-white"><h4 class="font-racing font-bold italic uppercase">FERNANDO</h4></div><div class="px-4 py-2 bg-indigo-50 text-center text-[10px] font-bold text-indigo-800 flex justify-around border-b border-indigo-100"><span> Efvo: <span id="ferWdCash">$0</span></span><span> Transf: <span id="ferWdTrans">$0</span></span><span> Directo: <span id="ferWdDirect">$0</span></span></div><div class="p-4 text-center border-b border-indigo-50"><p class="text-[10px] uppercase font-bold text-slate-400">GANANCIA DEL MES</p><p class="font-black text-3xl text-indigo-600" id="statFer">$0</p><div class="flex justify-center gap-3 mt-2 text-[10px] font-bold text-slate-500"><span class="bg-indigo-50 px-2 py-1 rounded">M.O.: <span id="ferLaborSplit">$0</span></span><span class="bg-indigo-50 px-2 py-1 rounded">R/S: <span id="ferPartsSplit">$0</span></span></div></div><div class="grid grid-cols-2 text-center divide-x divide-indigo-50 bg-slate-50"><div class="p-3"><p class="text-[9px] uppercase font-bold text-slate-400">RETIROS MES</p><p class="font-bold text-red-500 text-sm" id="statFerWd">$0</p></div><div class="p-3 bg-indigo-100"><p class="text-[9px] uppercase font-bold text-indigo-800">A COBRAR (SALDO)</p><p class="font-black text-lg text-indigo-900" id="balFer">$0</p></div></div></div>
                <div class="bg-white rounded-xl shadow-sm border border-emerald-200 overflow-hidden"><div class="bg-emerald-600 p-3 flex justify-between items-center text-white"><h4 class="font-racing font-bold italic uppercase">JOSE</h4></div><div class="px-4 py-2 bg-emerald-50 text-center text-[10px] font-bold text-emerald-800 flex justify-around border-b border-emerald-100"><span> Efvo: <span id="joseWdCash">$0</span></span><span> Transf: <span id="joseWdTrans">$0</span></span><span> Directo: <span id="joseWdDirect">$0</span></span></div><div class="p-4 text-center border-b border-emerald-50"><p class="text-[10px] uppercase font-bold text-slate-400">GANANCIA DEL MES</p><p class="font-black text-3xl text-emerald-600" id="statMe">$0</p><div class="flex justify-center gap-3 mt-2 text-[10px] font-bold text-slate-500"><span class="bg-emerald-50 px-2 py-1 rounded">M.O.: <span id="meLaborSplit">$0</span></span><span class="bg-emerald-50 px-2 py-1 rounded">R/S: <span id="mePartsSplit">$0</span></span></div></div><div class="grid grid-cols-2 text-center divide-x divide-emerald-50 bg-slate-50"><div class="p-3"><p class="text-[9px] uppercase font-bold text-slate-400">RETIROS MES</p><p class="font-bold text-red-500 text-sm" id="statMeWd">$0</p></div><div class="p-3 bg-emerald-100"><p class="text-[9px] uppercase font-bold text-emerald-800">A COBRAR (SALDO)</p><p class="font-black text-lg text-emerald-900" id="balMe">$0</p></div></div></div>
            </div>
            <div class="bg-amber-50 rounded-xl p-4 border-l-4 border-amber-500 shadow-sm mb-4 flex justify-between items-center"><div><p class="text-[10px] font-bold uppercase tracking-widest text-amber-600">CUENTAS POR COBRAR</p><p class="text-xs text-amber-700/60">Saldo pendiente del mes</p></div><p class="font-racing text-2xl font-black text-amber-600" id="pendingReceivable">$0</p></div>
            <div class="bg-slate-900 text-white p-3 rounded-lg flex justify-around mb-4" id="opsIndicators"><div class="text-center"><p class="text-[9px] text-slate-400 uppercase">VEHCULOS</p><p class="font-bold text-lg" id="countVehicles">0</p></div><div class="text-center"><p class="text-[9px] text-slate-400 uppercase">MOSTRADOR</p><p class="font-bold text-lg" id="countCounter">0</p></div></div>
            <div class="bg-white rounded-xl border border-slate-200 p-4 shadow-sm border-red-100"><div class="flex justify-between items-center mb-3 border-b border-red-100 pb-2"><h3 class="font-bold text-slate-700 text-xs uppercase flex items-center gap-2"><i data-lucide="alert-circle" class="w-4 h-4 text-red-500"></i> Gastos Fijos (Info)</h3><span class="font-bold text-red-600" id="expensesTotal">$0</span></div><div id="financeExpensesList" class="space-y-2 text-sm"></div></div>
        </div>
    </main>

    <!-- MENU -->
    <nav class="fixed bottom-0 left-0 w-full bg-white border-t border-slate-200 pb-safe z-50 shadow-lg">
        <div class="grid grid-cols-6 h-16 max-w-5xl mx-auto">
            <button onclick="window.switchTab('home')" id="tab-home" class="flex flex-col items-center justify-center transition tab-active border-b-0"><i data-lucide="wrench" class="w-5 h-5 mb-1"></i><span class="text-[8px] md:text-[10px] font-bold uppercase">TRABAJOS</span></button>
            <button onclick="window.switchTab('products')" id="tab-products" class="flex flex-col items-center justify-center transition tab-inactive border-b-0"><i data-lucide="package" class="w-5 h-5 mb-1"></i><span class="text-[8px] md:text-[10px] font-bold uppercase">PRECIOS</span></button>
            <button onclick="window.switchTab('search')" id="tab-search" class="flex flex-col items-center justify-center transition tab-inactive border-b-0"><i data-lucide="history" class="w-5 h-5 mb-1"></i><span class="text-[8px] md:text-[10px] font-bold uppercase">HISTORIAL</span></button>
            <button onclick="window.switchTab('withdrawals')" id="tab-withdrawals" class="flex flex-col items-center justify-center transition tab-inactive border-b-0"><i data-lucide="banknote" class="w-5 h-5 mb-1"></i><span class="text-[8px] md:text-[10px] font-bold uppercase">RETIROS</span></button>
            <button onclick="window.switchTab('expenses')" id="tab-expenses" class="flex flex-col items-center justify-center transition tab-inactive border-b-0"><i data-lucide="receipt" class="w-5 h-5 mb-1"></i><span class="text-[8px] md:text-[10px] font-bold uppercase">GASTOS</span></button>
            <button onclick="window.switchTab('finance')" id="tab-finance" class="flex flex-col items-center justify-center transition tab-inactive border-b-0"><i data-lucide="pie-chart" class="w-5 h-5 mb-1"></i><span class="text-[8px] md:text-[10px] font-bold uppercase">FINANZAS</span></button>
        </div>
    </nav>

    <!-- MODALS -->
    <div id="paymentModal" class="fixed inset-0 bg-slate-900/90 hidden z-[60] flex items-center justify-center px-4 backdrop-blur-sm"><div class="bg-white rounded-2xl w-full max-w-md shadow-2xl overflow-hidden flex flex-col max-h-[80vh]"><div class="p-4 bg-slate-900 text-white flex justify-between items-center"><h3 class="font-racing font-bold italic">COBROS <span class="text-red-500">CLIENTES</span></h3><button onclick="window.closePaymentModal()"><i data-lucide="x" class="w-5 h-5"></i></button></div><div class="p-5 text-center bg-slate-50 border-b border-slate-200"><p class="text-xs uppercase font-bold text-slate-400">SALDO PENDIENTE</p><p id="payBalance" class="text-3xl font-black text-slate-800 mt-1">$0</p></div><div class="flex-1 overflow-y-auto p-4 bg-white" id="paymentHistoryList"></div><div class="p-4 bg-slate-100 border-t border-slate-200 flex flex-col gap-2"><div class="flex justify-between items-center mb-2"><label class="text-xs font-bold text-slate-500">Monto y Medio:</label><label class="flex items-center gap-1 text-xs font-bold text-indigo-600 cursor-pointer"><input type="checkbox" id="payFullCheck" onchange="window.toggleFullPayModal()" class="w-4 h-4 rounded text-indigo-600"> SALDAR TOTAL</label></div><div class="flex gap-2"><select id="newPaymentMethod" class="inp text-sm font-bold text-slate-700 w-1/3"><option value="Efectivo"> Efvo</option><option value="Banco Jose"> Banco Jose</option><option value="Banco Fer"> Banco Fer</option></select><input type="number" id="newPaymentInput" placeholder="MONTO $" class="inp font-bold text-lg w-2/3"></div><button onclick="window.addPayment()" class="bg-green-600 hover:bg-green-700 text-white py-3 rounded-lg shadow-lg font-bold uppercase text-xs tracking-wide w-full mt-2">CONFIRMAR COBRO</button></div></div></div>
    <div id="viewerModal" class="fixed inset-0 bg-black/90 hidden z-[70] flex items-center justify-center px-4 backdrop-blur-sm"><div class="bg-white rounded-2xl w-full max-w-md shadow-2xl overflow-hidden flex flex-col max-h-[90vh]"><div class="p-4 bg-slate-900 text-white flex justify-between items-center border-b-4 border-red-600"><div><h3 class="font-racing font-bold italic text-lg">DETALLE TRABAJO</h3><p class="text-[10px] text-gray-400" id="viewDate">Fecha</p></div><button onclick="document.getElementById('viewerModal').classList.add('hidden')"><i data-lucide="x" class="w-6 h-6"></i></button></div><div class="p-5 overflow-y-auto"><div class="mb-4 border-b border-gray-100 pb-4"><p class="text-xs font-bold text-gray-400 uppercase">CLIENTE</p><h4 class="font-bold text-xl text-slate-800" id="viewClient">Nombre</h4><p class="text-sm text-slate-600 font-mono" id="viewCar">Auto | Patente</p></div><div class="mb-4"><p class="text-xs font-bold text-gray-400 uppercase mb-2">TRABAJOS REALIZADOS</p><div id="viewItemsList" class="space-y-2 text-sm text-slate-700"></div></div><div class="flex justify-between items-center bg-slate-100 p-3 rounded-lg mb-4"><span class="font-bold text-slate-500">TOTAL</span><span class="font-black text-2xl text-slate-800" id="viewTotal">$0</span></div><div id="viewPaymentsList" class="text-xs space-y-1 border-t pt-2 text-gray-500"></div></div><div class="p-4 bg-slate-50 border-t flex gap-2"><button onclick="window.printOrderFromView()" class="w-full bg-red-600 text-white py-3 rounded-lg font-bold uppercase flex justify-center items-center gap-2"><i data-lucide="file-text" class="w-4 h-4"></i> IMPRIMIR PDF</button></div></div></div>

    <script type="module">
        // --- CONFIG ---
        const firebaseConfig = { apiKey: "AIzaSyCNJYWARebyX0ISBk8azuMUuljFMvDu8kg", authDomain: "taller-app-18a48.firebaseapp.com", projectId: "taller-app-18a48", storageBucket: "taller-app-18a48.firebasestorage.app", messagingSenderId: "779429195426", appId: "1:779429195426:web:7e71d31fa9f966c27c71fb" };
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js"; import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js"; import { getFirestore, collection, addDoc, updateDoc, deleteDoc, doc, onSnapshot, query, orderBy, setDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // --- GLOBAL STATE ---
        let db, auth;
        let orders=[], expenses=[], withdrawals=[], products=[];
        let tempItems=[], editingOrderId=null, editingItemIndex=-1, activePaymentId=null, editingWithdrawalId=null, currentListFilter='all', viewingOrderId=null;
        let editingExpenseId = null;
        const today = new Date(); 
        // Correcci贸n de zona horaria para input date
        const localDate = new Date(today.getTime() - (today.getTimezoneOffset() * 60000)).toISOString().split('T')[0];
        document.getElementById('date').value = localDate; 
        document.getElementById('wdDate').value = localDate; 
        const currMonthStr = localDate.substring(0,7);
        document.getElementById('filterMonth').value = currMonthStr; 
        document.getElementById('dashMonth').value = currMonthStr;
        document.getElementById('wdHistoryFilter').value = currMonthStr;

        // --- HELPER FUNCTIONS ---
        window.safeSetText = (id, text) => { const el = document.getElementById(id); if(el) el.innerText = text; };
        window.formatMoney = (n) => { return new Intl.NumberFormat('es-AR', {style:'currency', currency:'ARS', maximumFractionDigits:0}).format(n); };
        window.exportToExcel = () => { let csv="ID,FECHA,CLIENTE,DNI,AUTO,TOTAL,ESTADO\n"; orders.forEach(o=>{csv+=`${o.customId||''},${o.date},${o.client.name},${o.client.dni||''},${o.client.model},${o.total},${o.status}\n`}); const link=document.createElement("a");link.href="data:text/csv;charset=utf-8,"+encodeURI(csv);link.download="Jofert_Data.csv";document.body.appendChild(link);link.click(); };
        // FIX: Parse local date string correctly without timezone shift
        window.parseDate = (dateStr) => { 
            if(!dateStr) return new Date(); 
            const parts = dateStr.split('-'); 
            // Year, Month (0-indexed), Day
            return new Date(parts[0], parts[1] - 1, parts[2]); 
        }; 

        // --- CORE LOGIC ---
        async function initApp() { 
            try { 
                const app = initializeApp(firebaseConfig); 
                auth = getAuth(app); 
                db = getFirestore(app); 
                await signInAnonymously(auth); 
                onAuthStateChanged(auth, (u) => { 
                    if (u) { 
                        document.getElementById('connectionStatus').classList.replace('bg-red-500', 'bg-green-500'); 
                        startListeners(); 
                    } 
                }); 
            } catch (e) { console.error(e); } 
        }
        
        function startListeners() {
            onSnapshot(query(collection(db, "orders"), orderBy("date", "desc")), (s) => { orders = s.docs.map(d => ({id:d.id, ...d.data()})); window.renderApp(); window.renderDashboard(); window.renderHistoryTable(); window.renderWithdrawals(); });
            onSnapshot(query(collection(db, "expenses"), orderBy("date", "desc")), (s) => { expenses = s.docs.map(d => ({id:d.id, ...d.data()})); window.renderDashboard(); window.renderExpensesList(); });
            onSnapshot(query(collection(db, "withdrawals"), orderBy("date", "desc")), (s) => { withdrawals = s.docs.map(d => ({id:d.id, ...d.data()})); window.renderWithdrawals(); window.renderDashboard(); });
            onSnapshot(query(collection(db, "products"), orderBy("desc")), (s) => { products = s.docs.map(d => ({id:d.id, ...d.data()})); window.renderProductsList(); });
        }

        // --- PRE-DEFINED FUNCTIONS ---
        // Define all UI interactions first to ensure they exist before any async calls
        
        window.toggleQuoteMode = () => { 
            const isQuote = document.getElementById('isQuoteToggle').checked; 
            document.getElementById('paymentSection').className = isQuote ? 'hidden' : 'bg-white/10 p-3 rounded-lg mb-3 border border-white/5'; 
            document.getElementById('orderFooter').classList.toggle('bg-amber-500', isQuote); 
            document.getElementById('orderFooter').classList.toggle('bg-slate-900', !isQuote); 
            document.getElementById('btnSaveText').innerText = isQuote ? "GUARDAR PRESUPUESTO" : "CONFIRMAR ORDEN"; 
            const titleEl = document.getElementById('formTitleText'); 
            if(editingOrderId) { titleEl.innerText = isQuote ? "EDITANDO PRESUPUESTO" : "EDITANDO ORDEN"; } 
            else { titleEl.innerText = isQuote ? "NUEVO PRESUPUESTO" : "NUEVO TRABAJO"; } 
        };

        window.toggleCostInput = () => { document.getElementById('itemBuyPrice').disabled = (document.getElementById('itemType').value === 'labor'); if(document.getElementById('itemType').value === 'labor') document.getElementById('itemBuyPrice').value = ''; };
        
        window.toggleCounterSale = () => { 
            const isCounter = document.getElementById('isCounterSale').checked; 
            document.getElementById('personalDataGroup').style.display = isCounter ? 'none' : 'contents'; 
            document.getElementById('vehicleDataGroup').style.display = isCounter ? 'none' : 'contents'; 
            if (isCounter) { document.getElementById('clientName').value = "CLIENTE MOSTRADOR"; document.getElementById('itemType').value = 'part'; window.toggleCostInput(); } 
            else { document.getElementById('clientName').value = ""; } 
        };

        window.resetForm = () => { 
            editingOrderId=null; 
            tempItems=[]; 
            document.querySelectorAll('.inp').forEach(i=>i.value=''); 
            document.getElementById('checkPaidFull').checked=false; 
            window.togglePaymentInput(); 
            document.getElementById('isQuoteToggle').checked = false; 
            window.toggleQuoteMode(); 
            document.getElementById('editModeHeader').classList.add('hidden'); 
            document.getElementById('btnCancelMain').classList.add('hidden'); 
            document.getElementById('editPaymentSection').classList.add('hidden'); 
            document.getElementById('formTitleText').innerText = "Nuevo Trabajo"; 
            document.getElementById('isCounterSale').checked = false; 
            window.toggleCounterSale(); 
            renderTempList(); 
        };

        window.togglePaymentInput = () => { const c=document.getElementById('checkPaidFull').checked; document.getElementById('initialPayment').disabled=c; if(c) document.getElementById('initialPayment').value=''; };

        window.addOrUpdateItem = () => { 
            const desc=document.getElementById('itemDesc').value.toUpperCase();
            const type=document.getElementById('itemType').value;
            const sell=parseFloat(document.getElementById('itemSellPrice').value);
            const buy=parseFloat(document.getElementById('itemBuyPrice').value); 
            if(!desc||isNaN(sell)) return alert("DATOS INCOMPLETOS"); 
            tempItems.push({desc, type, buyPrice:isNaN(buy)?0:buy, sellPrice:sell}); 
            document.getElementById('itemDesc').value=''; 
            document.getElementById('itemSellPrice').value=''; 
            document.getElementById('itemBuyPrice').value=''; 
            document.getElementById('itemMargin').value=''; 
            renderTempList(); 
        };

        window.renderTempList = () => { 
            const box=document.getElementById('tempListContainer'); 
            if(tempItems.length===0) return box.classList.add('hidden'); 
            box.classList.remove('hidden'); 
            document.getElementById('tempList').innerHTML=tempItems.map((i,x)=>`<tr class="border-b"><td class="py-2 text-slate-700 font-bold">${i.desc} <span class="text-[10px] text-gray-400 block uppercase">${i.type==='labor'?'MANO OBRA':(i.type==='service'?'SERVICIO':'REPUESTO')}</span></td><td class="text-right font-bold">$${i.sellPrice}</td><td class="text-right"><button onclick="window.delTemp(${x})" class="text-red-500"><i data-lucide="trash" class="w-4 h-4"></i></button></td></tr>`).join(''); 
            document.getElementById('previewTotal').innerText=window.formatMoney(tempItems.reduce((a,b)=>a+b.sellPrice,0)); 
            lucide.createIcons(); 
        };

        window.delTemp = (i) => { tempItems.splice(i,1); renderTempList(); };

        window.loadOrderForEdit = (id) => { 
            const o=orders.find(x=>x.id===id); if(!o)return; 
            editingOrderId=id; 
            tempItems=[...o.items]; 
            document.getElementById('clientName').value=o.client.name; 
            document.getElementById('clientPhone').value=o.client.phone; 
            document.getElementById('clientDni').value=o.client.dni||''; 
            document.getElementById('vehicleModel').value=o.client.model; 
            document.getElementById('vehiclePlate').value=o.client.plate; 
            document.getElementById('vehicleKm').value=o.client.km||''; 
            // FIX: Use parsed date to avoid timezone shifts on edit form load
            document.getElementById('date').value = new Date(window.parseDate(o.date)).toISOString().substring(0,10);
            
            const isQuote = o.docType === 'quote'; 
            document.getElementById('isQuoteToggle').checked = isQuote; 
            window.toggleQuoteMode(); 
            document.getElementById('editModeHeader').classList.remove('hidden'); 
            document.getElementById('btnCancelMain').classList.remove('hidden'); 
            document.getElementById('formTitleText').innerText = isQuote ? "Editando Presupuesto" : "Editando Orden"; 
            if(!isQuote) document.getElementById('editPaymentSection').classList.remove('hidden'); else document.getElementById('editPaymentSection').classList.add('hidden'); 
            window.switchTab('home'); 
            window.scrollTo({ top: 0, behavior: 'smooth' }); 
            renderTempList(); 
        };
        
        window.addExpenseFromTab = async () => { 
            const d=document.getElementById('dashMonth').value, desc=document.getElementById('manageExpenseDesc').value.toUpperCase(), a=parseFloat(document.getElementById('manageExpenseAmount').value), m=document.getElementById('manageExpenseMethod').value; 
            if(!desc||isNaN(a)) return alert("Datos incompletos"); 
            const data = {date:d,desc,amount:a,method:m,createdAt:new Date()};
            if (editingExpenseId) { await updateDoc(doc(db, "expenses", editingExpenseId), data); window.cancelEditExpense(); } else { await addDoc(collection(db,"expenses"), data); }
            document.getElementById('manageExpenseDesc').value=''; document.getElementById('manageExpenseAmount').value=''; 
        };

        window.loadExpenseForEdit = (id) => { 
            const exp = expenses.find(e => e.id === id); if (!exp) return; editingExpenseId = id; document.getElementById('manageExpenseDesc').value = exp.desc; document.getElementById('manageExpenseAmount').value = exp.amount; document.getElementById('manageExpenseMethod').value = exp.method; const btn = document.getElementById('btnSaveExpense'); btn.innerHTML = '<i data-lucide="save" class="w-4 h-4"></i> ACTUALIZAR'; btn.classList.replace('bg-red-600', 'bg-blue-600'); btn.classList.replace('hover:bg-red-700', 'hover:bg-blue-700'); document.getElementById('btnCancelExpense').classList.remove('hidden'); lucide.createIcons(); 
        };

        window.cancelEditExpense = () => { 
            editingExpenseId = null; document.getElementById('manageExpenseDesc').value = ''; document.getElementById('manageExpenseAmount').value = ''; document.getElementById('manageExpenseMethod').value = 'Efectivo'; const btn = document.getElementById('btnSaveExpense'); btn.innerHTML = '<i data-lucide="plus-circle" class="w-4 h-4"></i> REGISTRAR GASTO'; btn.classList.replace('bg-blue-600', 'bg-red-600'); btn.classList.replace('hover:bg-blue-700', 'hover:bg-red-700'); document.getElementById('btnCancelExpense').classList.add('hidden'); lucide.createIcons(); 
        };
        
        window.loadWithdrawalForEdit = (id) => { const w=withdrawals.find(i=>i.id===id); if(!w) return; editingWithdrawalId=id; document.getElementById('wdPerson').value=w.person; document.getElementById('wdMethod').value=w.method; document.getElementById('wdDate').value=w.date; document.getElementById('wdAmount').value=w.amount; document.getElementById('btnCancelWd').classList.remove('hidden'); document.getElementById('btnSaveWd').innerText="ACTUALIZAR"; document.getElementById('btnSaveWd').classList.replace('bg-red-600','bg-amber-500'); }
        window.cancelEditWithdrawal = () => { editingWithdrawalId=null; document.getElementById('wdAmount').value=''; document.getElementById('btnCancelWd').classList.add('hidden'); document.getElementById('btnSaveWd').innerText="CONFIRMAR"; document.getElementById('btnSaveWd').classList.replace('bg-amber-500','bg-red-600'); }
        window.addWithdrawal = async () => { const p=document.getElementById('wdPerson').value, m=document.getElementById('wdMethod').value, d=document.getElementById('wdDate').value, a=parseFloat(document.getElementById('wdAmount').value); if(isNaN(a)) return; const data={person:p,method:m,date:d,amount:a,createdAt:new Date()}; if(editingWithdrawalId) { await updateDoc(doc(db,"withdrawals",editingWithdrawalId),data); window.cancelEditWithdrawal(); } else { await addDoc(collection(db,"withdrawals"),data); document.getElementById('wdAmount').value=''; } };
        window.deleteWithdrawal=async(id)=>{if(confirm("驴BORRAR?"))await deleteDoc(doc(db,"withdrawals",id));};
        window.deleteOrder = async (id) => { if(confirm("驴ELIMINAR ESTE REGISTRO? Esta acci贸n no se puede deshacer.")) { try { await deleteDoc(doc(db, "orders", id)); } catch (error) { console.error("Error al eliminar:", error); alert("Hubo un error al eliminar."); } } };
        window.convertToOrder = async (id) => { 
            if(!confirm("驴APROBAR PRESUPUESTO Y CREAR ORDEN DE TRABAJO?")) return; 
            // Force local date string to prevent date shift
            const todayLocal = new Date(new Date().getTime() - (new Date().getTimezoneOffset() * 60000)).toISOString().substring(0,10);
            const newCustomId = generateId(todayLocal); 
            await updateDoc(doc(db,"orders",id), { docType: 'order', customId: newCustomId, status: 'pending', date: todayLocal, updatedAt: new Date() }); 
            currentListFilter = 'debt'; 
            document.getElementById('filter-debt').className = "filter-btn active"; // Visual update
            window.renderApp(); 
            alert(`隆Presupuesto aprobado! Orden N掳 ${newCustomId} creada con fecha ${todayLocal}.`); 
        };
        const generateId = (date) => { const m = date.substring(0,7); const max = orders.filter(o=>o.docType!=='quote' && o.customId && o.customId.startsWith(m)).reduce((m,o)=>{const s=parseInt(o.customId.split('-')[2]);return s>m?s:m},0); return `${m}-${String(max+1).padStart(3,'0')}`; };

        window.openCurrentOrderPayment = () => { if (editingOrderId) window.openPaymentModal(editingOrderId); };
        window.openPaymentModal=(id)=>{activePaymentId=id;const o=orders.find(x=>x.id===id);if(!o)return;document.getElementById('payBalance').innerText=window.formatMoney(o.total-(o.paidAmount||0));document.getElementById('paymentHistoryList').innerHTML=(o.payments||[]).map((p,i)=>`<div class="flex justify-between p-2 border-b text-sm"><span>${new Date(p.date).toLocaleDateString()}</span><span class="font-bold">${window.formatMoney(p.amount)}</span><span class="text-xs text-gray-400 ml-2">${p.method||'Efectivo'}</span><button onclick="window.delPay(${i})" class="text-red-500 ml-auto"><i data-lucide="trash" class="w-3 h-3"></i></button></div>`).join('');document.getElementById('paymentModal').classList.remove('hidden');lucide.createIcons();};
        window.closePaymentModal=()=>document.getElementById('paymentModal').classList.add('hidden');
        window.addPayment=async()=>{const v=parseFloat(document.getElementById('newPaymentInput').value); const m=document.getElementById('newPaymentMethod').value; if(isNaN(v))return;const o=orders.find(x=>x.id===activePaymentId);const np=[...(o.payments||[]),{amount:v,date:new Date().toISOString(),method:m}];const pa=np.reduce((a,b)=>a+b.amount,0);await updateDoc(doc(db,"orders",activePaymentId),{payments:np,paidAmount:pa,status:pa>=o.total-1?'paid':'partial'});document.getElementById('newPaymentInput').value='';window.closePaymentModal();}; 
        window.toggleFullPayModal = () => { const check = document.getElementById('payFullCheck'); const input = document.getElementById('newPaymentInput'); if (check.checked) { const o = orders.find(x => x.id === activePaymentId); if(o) { const bal = o.total - (o.paidAmount || 0); input.value = bal; input.disabled = true; } } else { input.value = ''; input.disabled = false; input.focus(); } };
        window.delPay=async(i)=>{if(!confirm("驴BORRAR PAGO?"))return;const o=orders.find(x=>x.id===activePaymentId);const np=[...o.payments];np.splice(i,1);const pa=np.reduce((a,b)=>a+b.amount,0);await updateDoc(doc(db,"orders",activePaymentId),{payments:np,paidAmount:pa,status:pa>=o.total-1?'paid':(pa>0?'partial':'pending')});window.openPaymentModal(activePaymentId);};
        
        // --- WHATSAPP ---
        window.sendWhatsApp = (id) => {
            const o = orders.find(x => x.id === id);
            if(!o) return;
            const isQuote = o.docType === 'quote';
            const typeText = isQuote ? "PRESUPUESTO" : "ORDEN DE TRABAJO";
            const clientName = o.client.name || "Cliente";
            let msg = `*JOFERT RACING*\nHola *${clientName}*, te env铆o el detalle de tu ${typeText.toLowerCase()}.\n\n`;
            if (o.client.model && o.client.model !== "VENTA MOSTRADOR") { msg += ` *Veh铆culo:* ${o.client.model} | ${o.client.plate || ''}\n`; }
            msg += ` *Fecha:* ${new Date(window.parseDate(o.date)).toLocaleDateString()}\n\n*TRABAJOS / REPUESTOS:*\n`;
            o.items.forEach(i => { msg += ` ${i.desc} - $${i.sellPrice}\n`; });
            msg += `\n *TOTAL: $${o.total}*\n`;
            if (!isQuote) { const paid = o.paidAmount || 0; const pending = o.total - paid; if (pending > 0) msg += `锔 *Saldo Pendiente:* $${pending}\n`; }
            msg += `\nGracias por confiar en nosotros!`;
            let phone = o.client.phone ? o.client.phone.replace(/[^0-9]/g, '') : "";
            if (phone.length === 10) phone = "549" + phone; 
            const url = phone ? `https://wa.me/${phone}?text=${encodeURIComponent(msg)}` : `https://wa.me/?text=${encodeURIComponent(msg)}`;
            window.open(url, '_blank');
        };

        // --- NAVIGATION ---
        window.switchTab = (t) => { 
            ['home','search','withdrawals','finance','products','expenses'].forEach(x => {
                const el = document.getElementById(`view-${x}`); if(el) el.classList.add('hidden');
                const btn = document.getElementById(`tab-${x}`); if(btn) btn.className="flex flex-col items-center justify-center transition tab-inactive border-b-0 h-full w-full";
            });
            const target = document.getElementById(`view-${t}`); if(target) target.classList.remove('hidden');
            const btn = document.getElementById(`tab-${t}`); if(btn) btn.className="flex flex-col items-center justify-center transition tab-active border-b-0 h-full w-full";
            if(t==='finance') window.renderDashboard();
            if(t==='expenses') window.renderExpensesList();
            if(t==='withdrawals') window.renderWithdrawals();
            if(t==='search') { document.getElementById('searchInput').value=''; window.renderHistoryTable(); document.getElementById('searchInput').focus(); }
        };

        // --- RENDER FUNCTIONS ---
        window.renderApp = () => {
            const m = document.getElementById('filterMonth').value;
            const l = document.getElementById('ordersList');
            if (!l) return;
            l.innerHTML = '';
            let visibleOrders = orders.filter(o => o.date.startsWith(m));
            if (currentListFilter === 'debt') visibleOrders = visibleOrders.filter(o => o.docType !== 'quote' && (o.status === 'pending' || o.status === 'partial'));
            else if (currentListFilter === 'paid') visibleOrders = visibleOrders.filter(o => o.docType !== 'quote' && o.status === 'paid');
            else if (currentListFilter === 'quote') visibleOrders = visibleOrders.filter(o => o.docType === 'quote');

            if (visibleOrders.length === 0) { l.innerHTML = '<p class="text-center text-sm text-slate-400 py-10 font-bold uppercase tracking-widest">NO HAY REGISTROS EN ESTA SECCIN</p>'; return; }
            l.innerHTML = visibleOrders.map(o => createOrderCard(o)).join('');
            lucide.createIcons();
        };

        function createOrderCard(o) {
            const isQuote = o.docType === 'quote';
            let borderClass = isQuote ? 'border-l-amber-400' : (o.status === 'paid' ? 'border-l-green-500' : (o.status === 'partial' ? 'border-l-yellow-500' : 'border-l-red-500'));
            let badge = isQuote ? '<span class="bg-amber-100 text-amber-700 px-2 py-0.5 rounded text-[10px] font-black tracking-wide">PRESUPUESTO</span>' : `<span class="bg-slate-100 px-1 rounded font-mono text-[10px] text-slate-500">${o.customId || '#'}</span>`;
            let actionButtons = isQuote ? `<button onclick="window.convertToOrder('${o.id}')" class="flex-1 bg-green-600 text-white rounded py-1.5 font-bold shadow-sm hover:bg-green-700 flex justify-center items-center gap-1 text-xs"><i data-lucide="check-circle" class="w-4 h-4"></i> APROBAR</button>` : `<button onclick="window.openPaymentModal('${o.id}')" class="flex-1 bg-white border border-slate-300 rounded py-1.5 font-bold text-slate-600 shadow-sm hover:bg-slate-50 text-xs">COBRAR</button>`;
            const clientName = o.client.name.toUpperCase();
            
            let waButton = `<button onclick="window.sendWhatsApp('${o.id}')" class="flex-1 bg-green-500 text-white rounded py-1.5 font-bold shadow-sm hover:bg-green-600 flex justify-center items-center gap-1 text-xs"><i data-lucide="message-circle" class="w-4 h-4"></i></button>`;

            let totalCost = 0; 
            if (o.items) o.items.forEach(i => { if (i.type !== 'labor') totalCost += (i.buyPrice || 0); });
            const margin = o.total - totalCost;

            return `<div class="bg-white border border-slate-200 rounded-xl p-4 shadow-sm border-l-4 ${borderClass} relative uppercase-force">
                ${isQuote ? '<div class="absolute top-2 right-2 opacity-10"><i data-lucide="file-text" class="w-12 h-12"></i></div>' : ''}
                <div class="flex justify-between items-start mb-2">
                    <div>
                        <div class="flex items-center gap-2 mb-1">${badge}<h4 class="font-bold text-slate-800">${clientName}</h4></div>
                        <p class="text-xs text-slate-500 font-bold">${(o.client.model || '').toUpperCase()} | ${(o.client.plate || '').toUpperCase()}</p><p class="text-[10px] text-slate-400 mt-1">${new Date(window.parseDate(o.date)).toLocaleDateString()}</p>
                    </div>
                    <div class="text-right relative z-10">
                        <span class="block font-black text-slate-800 text-lg">${window.formatMoney(o.total)}</span>
                        <span class="text-[10px] font-bold text-green-600 block">MARGEN: ${window.formatMoney(margin)}</span>
                        ${!isQuote && (o.total - (o.paidAmount || 0)) > 1 ? `<span class="text-[10px] text-red-500 font-bold block mt-1">FALTA ${window.formatMoney(o.total - (o.paidAmount || 0))}</span>` : ''}
                    </div>
                </div>
                <details class="text-xs relative z-10">
                    <summary class="cursor-pointer text-slate-400 py-1 border-t border-dashed mt-2 flex justify-between"><span>OPCIONES</span><i data-lucide="chevron-down" class="w-3 h-3 rotate-icon"></i></summary>
                    <div class="pt-2 space-y-1 bg-slate-50 -mx-4 -mb-4 p-4 mt-1 border-t border-slate-100">
                        ${o.items.map(i => `<div class="flex justify-between"><span>${i.desc.toUpperCase()}</span><span class="font-bold">${window.formatMoney(i.sellPrice)}</span></div>`).join('')}
                        <div class="flex gap-2 mt-3 pt-2 border-t border-slate-200">
                            <button onclick="window.printOrder('${o.id}')" class="p-1.5 bg-red-50 text-red-600 rounded border border-red-100 hover:bg-red-100" title="PDF"><i data-lucide="file-text" class="w-4 h-4"></i></button>
                            ${waButton}
                            ${actionButtons}
                            <button onclick="window.loadOrderForEdit('${o.id}')" class="p-1.5 bg-blue-50 text-blue-600 rounded border border-blue-100 hover:bg-blue-100" title="EDITAR"><i data-lucide="pencil" class="w-4 h-4"></i></button>
                            <button onclick="window.deleteOrder('${o.id}')" class="p-1.5 bg-gray-50 text-gray-400 rounded border border-gray-100 hover:text-red-500" title="ELIMINAR"><i data-lucide="trash" class="w-4 h-4"></i></button>
                        </div>
                    </div>
                </details>
            </div>`;
        }

        window.renderExpensesList = () => {
            const list = document.getElementById('manageExpensesList'); 
            const financeList = document.getElementById('financeExpensesList');
            
            if(list) {
                const showAll = document.getElementById('filterManageExpenses') && document.getElementById('filterManageExpenses').value === 'all';
                const m = document.getElementById('dashMonth').value;
                let displayExp = expenses;
                if (!showAll) { displayExp = expenses.filter(e => e.date === m); }
                
                if(displayExp.length === 0) { 
                    list.innerHTML = '<p class="text-center text-xs text-slate-400">Sin gastos</p>'; 
                } else {
                    list.innerHTML = displayExp.map(e => `
                        <div class="flex justify-between items-center text-xs p-3 bg-slate-50 border rounded-lg border-slate-200 hover:bg-white transition">
                            <div>
                                <span class="font-bold text-slate-800 block uppercase text-sm">${e.desc}</span>
                                <span class="text-[10px] text-slate-400">${e.date} | ${e.method||'Efvo'}</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <span class="font-black text-red-600 text-sm">-${window.formatMoney(e.amount)}</span>
                                <button onclick="window.loadExpenseForEdit('${e.id}')" class="p-2 bg-white border border-slate-200 rounded text-blue-400 hover:text-blue-600 hover:border-blue-300 transition"><i data-lucide="pencil" class="w-4 h-4"></i></button>
                                <button onclick="window.deleteExpense('${e.id}')" class="p-2 bg-white border border-slate-200 rounded text-slate-400 hover:text-red-500 hover:border-red-200 transition"><i data-lucide="trash" class="w-4 h-4"></i></button>
                            </div>
                        </div>`).join('');
                }
            }

            if(financeList) {
                 const m = document.getElementById('dashMonth').value;
                 const mExpenses = expenses.filter(e => e.date === m);
                 if(mExpenses.length === 0) { financeList.innerHTML = '<p class="text-center text-xs text-slate-400">Sin gastos este mes</p>'; } 
                 else { financeList.innerHTML = mExpenses.map(e => `<div class="flex justify-between items-center text-xs p-2 bg-slate-50 border rounded border-slate-200"><div><span class="font-bold text-slate-700 block uppercase">${e.desc}</span></div><div class="flex items-center gap-2"><span class="font-bold text-red-500">-${window.formatMoney(e.amount)}</span></div></div>`).join(''); }
            }
            lucide.createIcons();
        }

        window.renderWithdrawals = () => { 
            const l=document.getElementById('withdrawalsList'); if(!l) return; 
            const m = document.getElementById('wdHistoryFilter').value;
            
            const manualWd = withdrawals.map(w => ({...w, type: 'manual'}));
            const directWd = [];
            orders.forEach(o => {
                if(o.payments) {
                    o.payments.forEach(p => {
                        if(p.method === 'Banco Jose' || p.method === 'Banco Fer') {
                            directWd.push({
                                id: o.id + p.date,
                                date: p.date,
                                amount: p.amount,
                                person: p.method === 'Banco Fer' ? 'Fer' : 'Me',
                                method: 'Transferencia (Directo)',
                                type: 'direct',
                                orderCustomId: o.customId,
                                clientName: o.client.name
                            });
                        }
                    });
                }
            });

            const allWd = [...manualWd, ...directWd].filter(w => w.date.startsWith(m)).sort((a,b) => new Date(b.date) - new Date(a.date));

            if (allWd.length === 0) {
                l.innerHTML = '<p class="text-center text-slate-400 p-4">Sin movimientos en este mes.</p>';
            } else {
                l.innerHTML = allWd.map(w => {
                    const isFer = w.person === 'Fer';
                    const nameColor = isFer ? 'text-indigo-600' : 'text-emerald-600';
                    const name = isFer ? 'FERNANDO' : 'JOSE';
                    
                    if(w.type === 'direct') {
                         return `<div class="flex justify-between items-center p-3 hover:bg-slate-50 border-b text-sm group bg-slate-50/50"><div><span class="font-bold ${nameColor}">${name}</span> <span class="text-[10px] font-bold text-slate-500 bg-slate-200 px-1 rounded ml-1">AUTO (Orden #${w.orderCustomId || '?'})</span><p class="text-[9px] text-slate-400">${new Date(window.parseDate(w.date)).toLocaleDateString()} | ${w.clientName || 'Cliente'}</p></div><div class="flex items-center gap-2"><span class="font-bold text-slate-700">${window.formatMoney(w.amount)}</span><span class="text-xs text-gray-300"><i data-lucide="lock" class="w-3 h-3"></i></span></div></div>`;
                    } else {
                        return `<div class="flex justify-between items-center p-3 hover:bg-slate-50 border-b text-sm group"><div><span class="font-bold ${nameColor}">${name}</span> <span class="text-gray-400 text-xs">(${w.method})</span><p class="text-[9px] text-slate-400">${new Date(window.parseDate(w.date)).toLocaleDateString()}</p></div><div class="flex items-center gap-2"><span class="font-bold">${window.formatMoney(w.amount)}</span><button onclick="window.loadWithdrawalForEdit('${w.id}')" class="p-1 text-slate-300 hover:text-blue-500"><i data-lucide="pencil" class="w-3 h-3"></i></button><button onclick="window.deleteWithdrawal('${w.id}')" class="p-1 text-slate-300 hover:text-red-500"><i data-lucide="trash" class="w-3 h-3"></i></button></div></div>`;
                    }
                }).join('');
            }
            window.safeSetText('wdCount', allWd.length); 
            lucide.createIcons(); 
        }

        window.renderDashboard = () => {
            const m = document.getElementById('dashMonth').value;
            const mOrders = orders.filter(o => o.date.startsWith(m) && o.docType !== 'quote');
            const mExpenses = expenses.filter(e => e.date === m);
            let grossTotal=0, laborGross=0, partsGross=0, partsCost=0, pendingReceivable=0, vehiclesCount=0, counterCount=0;
            let repoFund = 0;
            let servicesGross=0, servicesCost=0;

            mOrders.forEach(o => { 
                o.items.forEach(i => { 
                    grossTotal += i.sellPrice; 
                    const cost = (i.buyPrice || 0);
                    
                    if(i.type === 'labor') { 
                        laborGross += i.sellPrice; 
                    } else if (i.type === 'service') {
                        servicesGross += i.sellPrice;
                        servicesCost += cost;
                        repoFund += cost; 
                    } else { 
                        // Default to part
                        partsGross += i.sellPrice; 
                        partsCost += cost;
                    } 
                });
                const paid = o.paidAmount || 0; if (paid < o.total) pendingReceivable += (o.total - paid);
                if(o.client.model === 'VENTA MOSTRADOR') counterCount++; else vehiclesCount++;
            });
            
            const fixedExpenses = mExpenses.reduce((sum, e) => sum + e.amount, 0);
            
            // --- NET CALCULATIONS ---
            const netLabor = laborGross - fixedExpenses;
            const netParts = partsGross - partsCost;
            const netServices = servicesGross - servicesCost;
            
            // --- SPLIT ---
            const ferLaborShare = netLabor * 0.70; 
            const joseLaborShare = netLabor * 0.30;
            
            const ferPartsShare = netParts * 0.50;
            const josePartsShare = netParts * 0.50;
            
            const ferServicesShare = netServices * 0.50;
            const joseServicesShare = netServices * 0.50;

            const ferProfit = ferLaborShare + ferPartsShare + ferServicesShare;
            const joseProfit = joseLaborShare + josePartsShare + joseServicesShare;

            const netProfitToSplit = netLabor + netParts + netServices;

            // --- CASH FLOW ---
            let cashIn = 0, bankIn = 0, cashOut = 0, bankOut = 0;
            
            // Cash In (Monthly)
            mOrders.forEach(o => {
                (o.payments || []).forEach(p => {
                    if(p.method === 'Efectivo') cashIn += p.amount;
                    else if(p.method === 'Banco') bankIn += p.amount;
                });
            });
            
            const mWithdrawals = withdrawals.filter(w => w.date.startsWith(m));
            let ferWd = 0, joseWd = 0;
            let ferWdCash = 0, ferWdTrans = 0, ferWdDirect = 0;
            let joseWdCash = 0, joseWdTrans = 0, joseWdDirect = 0;

            mWithdrawals.forEach(w => {
                if(w.person === 'Fer') {
                    ferWd += w.amount;
                    if(w.method === 'Efectivo') ferWdCash += w.amount; else ferWdTrans += w.amount;
                } else {
                    joseWd += w.amount;
                    if(w.method === 'Efectivo') joseWdCash += w.amount; else joseWdTrans += w.amount;
                }
                if(w.method === 'Banco') bankOut += w.amount; else cashOut += w.amount;
            });
            
            mExpenses.forEach(e => {
                 if(e.method === 'Banco') bankOut += e.amount; else cashOut += e.amount;
            });
            
            // Auto Withdrawals
            mOrders.forEach(o => {
                let orderCost = 0;
                if(o.items) o.items.forEach(i => { if(i.type !== 'labor') orderCost += (i.buyPrice || 0); });
                const ratio = (o.total > 0) ? ((o.total - orderCost) / o.total) : 0;
                (o.payments || []).forEach(p => {
                    if(p.method === 'Banco Jose') { 
                        const profitPortion = p.amount * ratio; 
                        joseWd += profitPortion; 
                        joseWdDirect += profitPortion;
                    }
                    if(p.method === 'Banco Fer') { 
                        const profitPortion = p.amount * ratio; 
                        ferWd += profitPortion; 
                        ferWdDirect += profitPortion;
                    }
                });
            });

            window.safeSetText('grossIncomeDisplay', window.formatMoney(grossTotal));
            window.safeSetText('repoBalanceHeader', window.formatMoney(repoFund)); 
            window.safeSetText('netProfitSplit', window.formatMoney(netProfitToSplit));
            window.safeSetText('pendingReceivable', window.formatMoney(pendingReceivable));
            
            window.safeSetText('laborGross', window.formatMoney(laborGross));
            window.safeSetText('laborExpenses', `-${window.formatMoney(fixedExpenses)}`);
            window.safeSetText('laborNet', window.formatMoney(netLabor));
            
            window.safeSetText('partsGross', window.formatMoney(partsGross));
            window.safeSetText('partsCostDisplay', `-${window.formatMoney(partsCost)}`);
            window.safeSetText('partsNet', window.formatMoney(netParts));

            window.safeSetText('servicesGross', window.formatMoney(servicesGross));
            window.safeSetText('servicesCostDisplay', `-${window.formatMoney(servicesCost)}`);
            window.safeSetText('servicesNet', window.formatMoney(netServices));
            
            window.safeSetText('statFer', window.formatMoney(ferProfit));
            window.safeSetText('ferLaborSplit', window.formatMoney(ferLaborShare));
            window.safeSetText('ferPartsSplit', window.formatMoney(ferPartsShare + ferServicesShare));
            window.safeSetText('statFerWd', `-${window.formatMoney(ferWd)}`);
            window.safeSetText('balFer', window.formatMoney(ferProfit - ferWd));
            window.safeSetText('ferWdCash', window.formatMoney(ferWdCash));
            window.safeSetText('ferWdTrans', window.formatMoney(ferWdTrans));
            window.safeSetText('ferWdDirect', window.formatMoney(ferWdDirect));

            window.safeSetText('statMe', window.formatMoney(joseProfit));
            window.safeSetText('meLaborSplit', window.formatMoney(joseLaborShare));
            window.safeSetText('mePartsSplit', window.formatMoney(josePartsShare + joseServicesShare));
            window.safeSetText('statMeWd', `-${window.formatMoney(joseWd)}`);
            window.safeSetText('balMe', window.formatMoney(joseProfit - joseWd));
            window.safeSetText('joseWdCash', window.formatMoney(joseWdCash));
            window.safeSetText('joseWdTrans', window.formatMoney(joseWdTrans));
            window.safeSetText('joseWdDirect', window.formatMoney(joseWdDirect));

            window.safeSetText('expensesTotal', window.formatMoney(fixedExpenses));
            window.safeSetText('cashBalance', window.formatMoney(cashIn - cashOut));
            window.safeSetText('bankBalance', window.formatMoney(bankIn - bankOut));
            
            if(document.getElementById('opsIndicators')) document.getElementById('opsIndicators').classList.remove('hidden');
            window.safeSetText('countVehicles', vehiclesCount);
            window.safeSetText('countCounter', counterCount);
            window.renderExpensesList();
            window.renderWithdrawals(); 
        };

        // --- ACTIONS ---
        window.deleteOrder = async (id) => {
            if(confirm("驴ELIMINAR ESTE REGISTRO? Esta acci贸n no se puede deshacer.")) {
                try { await deleteDoc(doc(db, "orders", id)); } catch (error) { console.error("Error", error); alert("Error al eliminar."); }
            }
        };

        window.searchProducts = (q) => { q = q.toUpperCase(); const drop = document.getElementById('productDropdown'); if (q.length < 2) { drop.classList.add('hidden'); return; } const matches = products.filter(p => p.desc.includes(q) || (p.code && p.code.includes(q))); if (matches.length === 0) { drop.classList.add('hidden'); return; } drop.innerHTML = matches.map(p => `<div onclick="window.selectProduct('${p.desc}', ${p.cost}, '${p.code || ''}')"><span class="text-xs text-gray-400 font-mono mr-2">${p.code || '#'}</span> ${p.desc} <span class="float-right text-gray-400">$${p.cost}</span></div>`).join(''); drop.classList.remove('hidden'); };
        window.selectProduct = (desc, cost, code) => { document.getElementById('itemDesc').value = desc; document.getElementById('itemType').value = 'part'; window.toggleCostInput(); document.getElementById('itemBuyPrice').value = cost; document.getElementById('productDropdown').classList.add('hidden'); document.getElementById('itemMargin').focus(); };
        window.calcPriceFromMargin = () => { const cost = parseFloat(document.getElementById('itemBuyPrice').value) || 0; const margin = parseFloat(document.getElementById('itemMargin').value) || 0; if (cost > 0) { const sell = cost * (1 + (margin / 100)); document.getElementById('itemSellPrice').value = Math.round(sell); } };
        window.importCSV = () => { const provider = document.getElementById('importProvider').value.toUpperCase(); if (!provider) return alert("Ingresa proveedor"); const file = document.getElementById('csvInput').files[0]; if (!file) return alert("Selecciona CSV"); const reader = new FileReader(); reader.onload = async (e) => { const rows = e.target.result.split('\n'); let count = 0; for (let row of rows) { const cols = row.split(','); if (cols.length >= 3) { const code = cols[0].trim().toUpperCase(); const desc = cols[1].trim().toUpperCase(); const cost = parseFloat(cols[2]); if (code && desc && !isNaN(cost)) { const existing = products.find(p => p.code === code); if (existing) { await updateDoc(doc(db, "products", existing.id), { desc, cost, provider }); } else { await addDoc(collection(db, "products"), { code, desc, cost, provider }); } count++; } } } alert(`Procesados ${count}`); document.getElementById('csvInput').value = ''; document.getElementById('importProvider').value = ''; }; reader.readAsText(file); };
        window.deleteByProvider = async () => { const p = document.getElementById('deleteProviderName').value.toUpperCase(); if(!p) return alert("Proveedor?"); const d = products.filter(x => x.provider === p); if(d.length===0) return alert("No encontrados"); if(confirm(`Borrar ${d.length}?`)) { for(let i of d) await deleteDoc(doc(db,"products",i.id)); alert("Listos"); document.getElementById('deleteProviderName').value=''; } };
        window.renderProductsList = () => { const q = document.getElementById('productSearch').value.toUpperCase(); const list = products.filter(p => p.desc.includes(q) || (p.code && p.code.includes(q))); document.getElementById('productsTableBody').innerHTML = list.slice(0,50).map(p => `<tr><td class="p-2 border-b text-xs font-mono text-slate-500">${p.code||'-'}</td><td class="p-2 border-b text-xs font-bold text-slate-700">${p.desc}</td><td class="p-2 border-b text-xs text-slate-500">${p.provider||'-'}</td><td class="p-2 border-b text-right text-xs font-mono">$${p.cost}</td><td class="p-2 border-b text-right"><button onclick="window.deleteProduct('${p.id}')" class="text-red-500"><i data-lucide="trash" class="w-3 h-3"></i></button></td></tr>`).join(''); lucide.createIcons(); };
        window.deleteProduct = async (id) => { if(confirm("驴Borrar?")) await deleteDoc(doc(db, "products", id)); };
        window.setListFilter = (t) => { currentListFilter=t; ['all','debt','quote','paid'].forEach(k=>document.getElementById(`filter-${k}`).className=`filter-btn ${k===t?'active':''}`); window.renderApp(); };
        window.renderHistoryTable = () => { const tbody = document.getElementById('historyTableBody'); if(!tbody) return; const q = document.getElementById('searchInput').value.toUpperCase(); const history = orders.filter(o => o.docType !== 'quote'); const filtered = q.length === 0 ? history.slice(0, 20) : history.filter(o => (o.client.name && o.client.name.toUpperCase().includes(q)) || (o.client.plate && o.client.plate.toUpperCase().includes(q)) || (o.client.dni && o.client.dni.toUpperCase().includes(q))); if(filtered.length === 0) { tbody.innerHTML = '<tr><td colspan="5" class="text-center py-4 text-slate-400">SIN RESULTADOS</td></tr>'; return; } tbody.innerHTML = filtered.map(o => { const km = o.client.km || '-'; return `<tr onclick="window.viewOrderDetails('${o.id}')" class="cursor-pointer hover:bg-slate-100"><td>${new Date(window.parseDate(o.date)).toLocaleDateString()}</td><td>${o.client.plate} <br><span class="text-[9px] text-slate-400">${o.client.model}</span></td><td>${o.client.name}</td><td>${km}</td><td>${window.formatMoney(o.total)}</td></tr>` }).join(''); };
        window.performSearch = () => { window.renderHistoryTable(); };
        window.viewOrderDetails = (id) => { const o = orders.find(x => x.id === id); if(!o) return; viewingOrderId = id; document.getElementById('viewDate').innerText = new Date(window.parseDate(o.date)).toLocaleDateString(); document.getElementById('viewClient').innerText = o.client.name; document.getElementById('viewCar').innerText = `${o.client.model} | ${o.client.plate}`; document.getElementById('viewItemsList').innerHTML = o.items.map(i => `<div class="flex justify-between border-b border-gray-100 pb-1"><span>${i.desc}</span><span class="font-bold">${window.formatMoney(i.sellPrice)}</span></div>`).join(''); document.getElementById('viewTotal').innerText = window.formatMoney(o.total); document.getElementById('viewPaymentsList').innerHTML = (o.payments && o.payments.length > 0) ? `<p class="font-bold mb-1">PAGOS REGISTRADOS:</p>` + o.payments.map(p => `<div class="flex justify-between"><span>${new Date(p.date).toLocaleDateString()} (${p.method||'Efvo'})</span><span class="text-green-600 font-bold">${window.formatMoney(p.amount)}</span></div>`).join('') : `<p class="italic">Sin pagos registrados</p>`; document.getElementById('viewerModal').classList.remove('hidden'); };
        window.printOrderFromView = () => { 
            const o = orders.find(x => x.id === viewingOrderId); 
            if(!o) return; 
            const isQuote = o.docType === 'quote'; 
            const { jsPDF } = window.jspdf; 
            const doc = new jsPDF(); 
            const img = new Image();
            img.src = 'logo.png';
            img.onload = () => {
                doc.addImage(img, 'PNG', 10, 10, 25, 25);
                const headerColor = isQuote ? [245, 158, 11] : [220, 38, 38]; 
                doc.setFillColor(20, 20, 20); 
                doc.rect(0, 38, 210, 2, 'F'); 
                doc.saveGraphicsState(); doc.setGState(new doc.GState({opacity: 0.05})); doc.addImage(img, 'PNG', 55, 80, 100, 100); doc.restoreGraphicsState();
                doc.setTextColor(30, 30, 30); doc.setFontSize(22); doc.setFont("helvetica", "bolditalic"); doc.text("JOFERT RACING", 40, 20); 
                doc.setTextColor(100, 100, 100); doc.setFontSize(10); doc.setFont("helvetica", "normal"); doc.text("Puerto San Julian 1350, Presidente Derqui", 40, 26); doc.text("Tel: 11-2159-8743 | 11-3474-7603", 40, 31);
                doc.setFillColor(220, 38, 38); doc.rect(130, 10, 70, 20, 'F'); doc.setTextColor(255, 255, 255); doc.setFontSize(12); doc.setFont("helvetica", "bold"); const title = isQuote ? "PRESUPUESTO OFICIAL" : "ORDEN DE TRABAJO"; doc.text(title, 165, 19, null, null, "center"); doc.setFontSize(10); doc.text(`N掳: ${o.customId}`, 165, 26, null, null, "center");
                doc.setTextColor(0,0,0); doc.setFontSize(10); doc.text(`FECHA: ${new Date(window.parseDate(o.date)).toLocaleDateString()}`, 14, 50); 
                doc.setDrawColor(200); doc.setFillColor(245, 245, 245); doc.rect(14, 55, 182, 25, 'F'); doc.setFont("helvetica", "bold"); doc.text("CLIENTE:", 18, 62); doc.text("VEHCULO:", 110, 62); doc.setFont("helvetica", "normal"); doc.text(`${o.client.name}`, 18, 68); doc.text(`DNI: ${o.client.dni||'-'}  |  Tel: ${o.client.phone}`, 18, 74); doc.text(`${o.client.model}`, 110, 68); doc.text(`Patente: ${o.client.plate}  |  KM: ${o.client.km || '-'}`, 110, 74); 
                const body = o.items.map(i => [i.desc, i.type==='labor'?'Mano de Obra':(i.type==='service'?'Servicio':'Repuesto'), window.formatMoney(i.sellPrice)]); 
                doc.autoTable({ startY: 95, head: [['Descripci贸n', 'Tipo', 'Importe']], body: body, theme: 'grid', headStyles: { fillColor: [220, 38, 38], textColor: 255, fontStyle: 'bold' }, styles: { fontSize: 10, cellPadding: 3 } }); 
                const finalY = doc.lastAutoTable.finalY + 10; doc.setFontSize(14); doc.setFont("helvetica", "bold"); doc.setTextColor(0,0,0); doc.text(`TOTAL: ${window.formatMoney(o.total)}`, 196, finalY, null, null, "right"); 
                if(!isQuote) { const paid = o.paidAmount||0; const bal = o.total - paid; if(paid>0) { doc.setFontSize(10); doc.setTextColor(22,163,74); doc.text(`Pagado: ${window.formatMoney(paid)}`, 196, finalY+6, null, null, "right"); } if(bal>0) { doc.setTextColor(220,38,38); doc.text(`Pendiente: ${window.formatMoney(bal)}`, 196, finalY+12, null, null, "right"); } } 
                doc.save(`${isQuote?'Presupuesto':'Orden'}_Jofert_${o.client.name.replace(/\s/g,'_')}.pdf`);
            };
            img.onerror = () => { alert("Logo no encontrado, imprimiendo sin imagen."); };
        };
        window.printOrder = (id) => { viewingOrderId = id; window.printOrderFromView(); };
        window.addEventListener('load', initApp);
    </script>
</body>
</html>
